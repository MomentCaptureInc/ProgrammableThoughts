<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/css/bootstrap.min.css" integrity="sha512-o/MhoRPVLExxZjCFVBsm17Pkztkzmh7Dp8k7/3JrtNCHh0AQ489kwpfA3dPSHzKDe8YCuEhxXq3Y71eb/o6amg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.6/css/selectize.bootstrap5.css" integrity="sha512-wD3+yEMEGhx4+wKKWd0bNGCI+fxhDsK7znFYPvf2wOVxpr7gWnf4+BKphWnUCzf49AUAF6GYbaCBws1e5XHSsg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/js/bootstrap.min.js" integrity="sha512-Hqe3s+yLpqaBbXM6VA0cnj/T56ii5YjNrMT9v+us11Q81L0wzUG0jEMNECtugqNu2Uq5MSttCg0p4KK0kCPVaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.6/js/standalone/selectize.min.js" integrity="sha512-pgmLgtHvorzxpKra2mmibwH/RDAVMlOuqU98ZjnyZrOZxgAR8hwL8A02hQFWEK25V40/9yPYb/Zc+kyWMplgaA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      body {
        margin: 1em;
      }
      #audioPlayer {
        border: none;
      }
      .hidden {
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div id="statusContainer" class="hidden">
      <h2 id="statusText"></h2>
    </div>
    <div class="container hidden">
      <form class="row g-3 needs-validation" novalidate>
        <div class="col-12">
          <textarea class="form-control" readonly id="origThought" rows="3" tabindex="-1" required></textarea>
        </div>
        <div class="col-12">
          <audio id="audioPlayer" class="form-control" id="recording" controls>
            <source id="audioSource" src="" type="audio/mpeg">
          </audio>
        </div>
        <div class="col-12">
          <textarea class="form-control" id="newThought" rows="3" tabindex="-1" required></textarea>
        </div>
        <div class="col-12">
          <input type="text" class="form-control" id="tagInput" value="" placeholder="Tags" tabindex="-1" style="display: none;">
        </div>
        <div class="col-8">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="favorite" tabindex="-1" required>
            <label class="form-check-label" for="favorite">
              Favorite
            </label>
          </div>
        </div>
        <div class="d-grid col-4 mx-auto">
          <button type="button" id="saveButton" class="btn btn-outline-primary">Save</button>
        </div>
      </form>
    </div>
  <script>
    $(function() {
      const id = $('#thoughtID').html();
      console.log("id: " + id);
      if (id) {
        google.script.run
          .withSuccessHandler((e) => {
            console.log("getThoughtData success:", e);
            $('.container').removeClass('hidden');
            $('#origThought').html(e.text);
            $('#newThought').html(e.text.split(' (')[0]);
            $("#audioSource").attr("src", "https://drive.google.com/uc?export=download&id=" + id);
            $("#audioPlayer")[0].load();
            $("#favorite").prop('checked', e.favorite);
            $('#tagInput').val(e.tags);
            $("#tagInput").selectize({
              delimiter: ",",
              persist: false,
              create: function (input) {
                return {
                  value: input,
                  text: input,
                };
              },
            });
          })
          .withFailureHandler((e) => {
            console.log("getThoughtData failure:", e);
            $('.container').addClass('hidden');
            $('#statusContainer').removeClass('hidden');
            $('#statusText').html(e.status);
          })
          .getThoughtData(id);
        $( "#saveButton" ).click(function() {
          const data = {};
          data.id = id;
          data.text = $('#newThought').val();
          data.tags = $('#tagInput').val();
          data.favorite = $("#favorite").is(':checked');
          console.log("saveButton click:", data)
          $('.container').addClass('hidden');
          google.script.run
            .withSuccessHandler((e) => {
              console.log("saveThoughtData success:", e);
              $('#statusContainer').removeClass('hidden');
              $('#statusText').html(e.status);
            })
            .withFailureHandler((e) => {
              console.log("saveThoughtData failure:", e);
              $('#statusContainer').removeClass('hidden');
              $('#statusText').html(e.status);
            })
            .saveThoughtData(data);
        });
      }
    });
  </script>
  </body>
</html>